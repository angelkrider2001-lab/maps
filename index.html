<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #c0392b;
            --accent-hover: #a93226;
            --bg-main: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f5f5f5;
            --text-primary: #2c3e50;
            --text-secondary: #5d6d7e;
            --border: #dfe6e9;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            max-width: 100%;
        }

        .app-container {
            display: grid;
            grid-template-columns: 420px 1fr;
            grid-template-rows: 1fr auto;
            height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
        }

        .map-container {
            grid-row: 1 / -1;
        }

        /* Sidebar - white card */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            grid-row: 1;
            grid-column: 1;
        }

        .input-section {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .input-section label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .link-input-wrapper {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .input-section .link-input-wrapper input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .input-section .link-input-wrapper input::placeholder {
            color: var(--text-secondary);
        }

        .input-section .link-input-wrapper input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-section .btn-primary {
            background: var(--accent);
            color: white;
        }

        .input-section .btn-primary:hover {
            background: var(--accent-hover);
        }

        .input-section .icon-btn {
            background: var(--accent);
            border-color: transparent;
            color: white;
        }

        .input-section .icon-btn:hover {
            background: var(--accent-hover);
        }

        .btn-sort-places,
        .input-section .btn-sort-places {
            background: var(--accent) !important;
            color: white !important;
            border: none !important;
        }

        .btn-sort-places:hover {
            background: var(--accent-hover) !important;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-input);
        }

        .icon-btn-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: var(--bg-input);
            border-color: var(--accent);
        }

        .share-btn {
            display: inline-flex;
            align-items: stretch;
            border: none;
            border-radius: 0;
            cursor: pointer;
            overflow: hidden;
            font-weight: 600;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        .share-btn .share-text {
            background: var(--accent);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
        }

        .share-btn .share-icon {
            background: var(--accent-hover);
            color: white;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .share-btn:hover .share-text {
            background: #d1402f;
        }

        .share-btn:hover .share-icon {
            background: #962b21;
        }

        .sort-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: var(--bg-main);
            flex-direction: column;
        }

        .sort-modal-overlay.visible {
            display: flex;
        }

        .sort-modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            flex-shrink: 0;
        }

        .sort-modal-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .sort-modal-close {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sort-modal-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .sort-modal-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            cursor: grab;
        }

        .sort-modal-item:active {
            cursor: grabbing;
        }

        .sort-modal-item .drag-handle {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .sort-modal-item span {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
        }

        .sort-modal-item.dragging {
            opacity: 0.5;
        }

        .sort-modal-item.drag-over {
            border-color: var(--accent);
            background: rgba(192,57,43,0.08);
        }

        .sort-modal-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0.25rem;
        }

        .sort-modal-remove:hover {
            color: var(--accent);
        }

        .icon-btn-mobile {
            display: none !important;
        }

        .sidebar-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 0.75rem 1rem 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .btn-sort-places {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            white-space: nowrap;
            border: none;
        }

        .places-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        .places-list.places-list-hidden {
            display: none !important;
        }

        #placesTitle {
            display: none !important;
        }

        .place-card {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0;
            width: 100%;
            flex-shrink: 0;
            min-width: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow-y: auto;
            max-height: 100%;
        }

        .place-card:hover {
            border-color: var(--accent);
        }

        .place-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(192,57,43,0.2);
        }

        .place-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .place-card .drag-handle {
            cursor: grab;
            padding: 0.25rem;
            margin-right: 0.5rem;
            color: var(--text-secondary);
            user-select: none;
        }

        .place-card .drag-handle:active {
            cursor: grabbing;
        }

        .place-card.dragging {
            opacity: 0.5;
        }

        .place-card.drag-over {
            border-color: var(--accent);
            background: rgba(192,57,43,0.08);
        }

        .place-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .place-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.2rem;
            line-height: 1;
            opacity: 0.7;
        }

        .place-remove:hover {
            color: var(--accent);
            opacity: 1;
        }

        .place-card .place-card-details {
            display: none;
            padding: 0 1rem 1rem;
        }

        .place-card.expanded .place-card-details {
            display: block;
        }

        .place-card .place-card-header {
            padding: 1rem;
        }

        .place-card .expand-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            margin-right: 0.5rem;
        }

        .place-card .address {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .place-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .place-rating .stars {
            color: #e67e22;
        }

        .place-photos {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .place-photos img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .place-reviews {
            margin-top: 0.75rem;
        }

        .place-reviews .review {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .place-reviews .review:last-child {
            border-bottom: none;
        }

        .place-opening-hours {
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .place-opening-hours .hours-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .place-opening-hours .open-now {
            color: #27ae60;
            font-weight: 500;
        }

        .place-opening-hours .closed-now {
            color: var(--accent);
        }

        .distances-section {
            padding: 1rem;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            grid-row: 2;
            grid-column: 1;
        }

        .distances-section h4 {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }

        .distance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            gap: 0.5rem;
        }

        .distance-row span:first-child {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .distance-row:last-child {
            border-bottom: none;
        }

        .distance-info {
            color: var(--accent);
        }

        /* Map container - white card with shadow */
        .map-container {
            position: relative;
            margin: 0.75rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: var(--bg-card);
            border: 1px solid var(--border);
            min-width: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin-bottom: 1rem;
        }

        .loading-place {
            padding: 1rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .map-type-toggle {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 5;
            display: flex;
            gap: 0;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .map-type-toggle button {
            padding: 0.5rem 1rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            font-family: inherit;
        }

        .map-type-toggle button.active {
            background: var(--bg-input);
            color: var(--text-primary);
            font-weight: 500;
        }

        @media (max-width: 900px) {
            body {
                overflow-x: hidden;
            }

            .app-container {
                grid-template-columns: minmax(0, 1fr);
                grid-template-rows: auto 1fr auto;
                width: 100%;
                min-width: 0;
            }

            .sidebar {
                min-width: 0;
                max-height: none;
                min-height: 0;
                overflow: hidden;
                overflow-x: hidden;
                display: flex;
                flex-direction: column;
            }

            .map-container {
                grid-row: auto;
                min-width: 0;
            }

            .distances-section.distances-below-map {
                grid-column: 1;
                grid-row: 3;
                margin: 0 0.5rem 0.5rem;
                border-radius: 12px;
                border: 1px solid var(--border);
                min-width: 0;
            }

            .input-section {
                flex-shrink: 0;
            }

            .distances-section {
                flex-shrink: 0;
            }

            .sidebar-section-title {
                flex-shrink: 0;
            }

            .places-list {
                flex: 1;
                min-height: 120px;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }

            .place-card {
                flex-shrink: 0;
                min-height: 60px;
                overflow-x: hidden;
            }

            .place-card h3 {
                font-size: 0.95rem;
                line-height: 1.3;
            }

            .link-input-wrapper {
                flex-wrap: wrap;
            }

            .link-input-wrapper input {
                min-width: 0;
            }

            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .icon-btn-mobile {
                display: flex;
            }

            .map-container {
                margin: 0.5rem;
                min-height: 55vh;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="input-section">
                <label>Œ†œÅœåœÉŒ∏ŒµœÉŒµ ŒºŒ≠œÅŒøœÇ</label>
                <div class="link-input-wrapper">
                    <input type="text" id="mapLinkInput" placeholder="Link from Google Maps" 
                           onkeypress="if(event.key==='Enter') addPlace()">
                    <button class="btn btn-primary" onclick="addPlace()">Œ†œÅŒøœÉŒ∏ŒÆŒ∫Œ∑</button>
                </div>
                <div class="icon-btn-row">
                    <button class="icon-btn icon-btn-mobile" id="sortBtn" onclick="openSortModal()" style="display:none" title="Œ§Œ±ŒæŒπŒΩœåŒºŒ∑œÉŒ∑ œÉŒµŒπœÅŒ¨œÇ">‚Üï</button>
                    <button class="btn btn-sort-places" id="sortPlacesBtn" onclick="openSortModal()" style="display:none">Œ§Œ±ŒæŒπŒΩœåŒºŒ∑œÉŒ∑</button>
                    <button class="share-btn" id="shareBtn" onclick="copyShareLink()" style="display:none" title="ŒöŒøŒπŒΩŒÆ œáœÅŒÆœÉŒ∑ link"><span class="share-text">SHARE</span><span class="share-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/></svg></span></button>
                    <button class="icon-btn" onclick="clearAll()" title="ŒöŒ±Œ∏Œ±œÅŒπœÉŒºœåœÇ œåŒªœâŒΩ">üóë</button>
                </div>
            </div>

            <div class="sidebar-section-title" id="placesTitle" style="display: none;">
                <span>üìç Œ§Œ± ŒºŒ≠œÅŒ∑ œÉŒøœÖ</span>
            </div>
            <div class="places-list places-list-hidden" id="placesList">
                <div class="empty-state" id="emptyState">
                    <p><strong>Œ†œÅœåœÉŒ∏ŒµœÉŒµ œÄŒøŒªŒªŒ¨ links Œ±œÄœå Google Maps</strong></p>
                    <p>ŒòŒ± Œ¥ŒµŒπœÇ œÑŒ±œÖœÑœåœáœÅŒøŒΩŒ± Œ≥ŒπŒ± œåŒªŒ±: œÜœâœÑŒøŒ≥œÅŒ±œÜŒØŒµœÇ, Œ±ŒæŒπŒøŒªŒøŒ≥ŒÆœÉŒµŒπœÇ, œâœÅŒ¨œÅŒπŒø Œ∫Œ±Œπ Œ±œÄŒøœÉœÑŒ¨œÉŒµŒπœÇ!</p>
                </div>
            </div>
        </aside>

        <main class="map-container">
            <div class="map-type-toggle">
                <button type="button" id="mapTypeBtn" class="active" onclick="setMapType('roadmap')">ŒßŒ¨œÅœÑŒ∑œÇ</button>
                <button type="button" id="satelliteBtn" onclick="setMapType('satellite')">Satellite</button>
            </div>
            <div id="map"></div>
        </main>

        <div class="distances-section distances-below-map" id="distancesSection" style="display: none;">
            <h4>üìè ŒëœÄŒøœÉœÑŒ¨œÉŒµŒπœÇ ŒºŒµœÑŒ±Œæœç ŒºŒµœÅœéŒΩ (ŒºŒµ œÑŒ∑ œÉŒµŒπœÅŒ¨ œÄŒøœÖ œÑŒ± Œ≠Œ≤Œ±ŒªŒµœÇ)</h4>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Œ£œçœÅŒµ œÑŒ± ŒºŒ≠œÅŒ∑ Œ≥ŒπŒ± ŒΩŒ± Œ±ŒªŒªŒ¨ŒæŒµŒπœÇ œÑŒ∑ œÉŒµŒπœÅŒ¨</p>
            <div id="distancesList"></div>
        </div>

        <div class="sort-modal-overlay" id="sortModal">
            <div class="sort-modal-header">
                <h3>Œ§Œ±ŒæŒπŒΩœåŒºŒ∑œÉŒ∑ ŒºŒµœÅœéŒΩ ‚Äî œÉœçœÅŒµ Œ≥ŒπŒ± Œ±ŒªŒªŒ±Œ≥ŒÆ œÉŒµŒπœÅŒ¨œÇ</h3>
                <button class="sort-modal-close" onclick="closeSortModal()">√ó</button>
            </div>
            <div class="sort-modal-list" id="sortModalList"></div>
        </div>

    </div>

    <script>
        const API_KEY = 'AIzaSyDc__yRSw8pvfjlthJ6YlQ9AH8qbbZXXCg';
        let map;

        function log() {} // no-op
        let placesService;
        let geocoder;
        let markers = [];
        let places = [];
        let directionsService;
        let directionsRenderer;
        let PlaceInfoOverlay;
        let RouteLabelOverlay;
        let routeLabelOverlays = [];

        function initMap() {
            log('initMap: ŒëœÅœáŒπŒ∫ŒøœÄŒøŒØŒ∑œÉŒ∑ œáŒ¨œÅœÑŒ∑...');
            PlaceInfoOverlay = class extends google.maps.OverlayView {
                constructor(position, place, map) {
                    super();
                    this.position = position;
                    this.place = place;
                    this.map = map;
                    this.div = null;
                }
                onAdd() {
                    const div = document.createElement('div');
                    div.className = 'map-place-card';
                    div.style.cssText = 'position:absolute;background:#fff;border:1px solid #dfe6e9;border-radius:10px;padding:8px;max-width:200px;box-shadow:0 2px 12px rgba(0,0,0,0.12);cursor:pointer;z-index:10;';
                    const mapsUrl = buildMapsUrl(this.place, this.position);
                    let img = '';
                    if (this.place.photos && this.place.photos.length > 0) {
                        img = `<a href="${mapsUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="display:block;cursor:pointer;"><img src="${this.place.photos[0].getUrl({maxWidth:120,maxHeight:80})}" style="width:100%;height:70px;object-fit:cover;border-radius:6px;margin-bottom:6px;" alt="ŒÜŒΩŒøŒπŒ≥ŒºŒ± œÉŒµ Google Maps"></a>`;
                    }
                    const rating = this.place.rating ? `‚≠ê ${this.place.rating}` : '';
                    const reviewsCount = (this.place.user_ratings_total || 0) > 0 ? `(${this.place.user_ratings_total} Œ±ŒæŒπŒøŒªŒøŒ≥ŒÆœÉŒµŒπœÇ)` : '';
                    div.innerHTML = img + `<div style="font-size:13px;font-weight:600;color:#2c3e50;">${this.place.name}</div><div style="font-size:11px;color:#5d6d7e;">${rating} ${reviewsCount}</div>`;
                    this.div = div;
                    const panes = this.getPanes();
                    panes.overlayMouseTarget.appendChild(div);
                    const self = this;
                    div.addEventListener('click', (e) => {
                        if (e.target.tagName === 'A' || e.target.closest('a')) return;
                        if (window.lastInfoWindow) window.lastInfoWindow.close();
                        const iw = new google.maps.InfoWindow({ content: buildInfoContent(self.place) });
                        iw.open(this.map, { position: self.position });
                        window.lastInfoWindow = iw;
                    });
                }
                draw() {
                    if (!this.div || !this.position) return;
                    const proj = this.getProjection();
                    if (!proj) return;
                    const point = proj.fromLatLngToDivPixel(this.position);
                    if (point) {
                        const zoom = this.map && this.map.getZoom ? this.map.getZoom() : 0;
                        const isMobile = window.innerWidth <= 900;
                        let scale = 1;
                        if (isMobile) {
                            if (zoom <= 9) scale = 0.62;
                            else if (zoom <= 11) scale = 0.75;
                            else if (zoom <= 13) scale = 0.9;
                        }
                        this.div.style.left = point.x + 'px';
                        this.div.style.top = (point.y + 25) + 'px';
                        this.div.style.transformOrigin = 'top center';
                        this.div.style.transform = `translateX(-50%) scale(${scale})`;
                    }
                }
                onRemove() {
                    if (this.div && this.div.parentNode) this.div.parentNode.removeChild(this.div);
                    this.div = null;
                }
            };
            RouteLabelOverlay = class extends google.maps.OverlayView {
                constructor(position, text, map) {
                    super();
                    this.position = position;
                    this.text = text;
                    this.div = null;
                }
                onAdd() {
                    const div = document.createElement('div');
                    div.style.cssText = 'position:absolute;background:#c0392b;color:white;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:9;pointer-events:none;';
                    div.textContent = this.text;
                    this.div = div;
                    this.getPanes().overlayMouseTarget.appendChild(div);
                }
                draw() {
                    if (!this.div || !this.position) return;
                    const proj = this.getProjection();
                    if (!proj) return;
                    const point = proj.fromLatLngToDivPixel(this.position);
                    if (point) {
                        this.div.style.left = (point.x - this.div.offsetWidth / 2) + 'px';
                        this.div.style.top = (point.y - 20) + 'px';
                    }
                }
                onRemove() {
                    if (this.div && this.div.parentNode) this.div.parentNode.removeChild(this.div);
                    this.div = null;
                }
            };
            const mapStyles = [
                { elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'administrative', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'road', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', elementType: 'labels', stylers: [{ visibility: 'off' }] },
                { featureType: 'water', elementType: 'labels', stylers: [{ visibility: 'off' }] }
            ];
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.9838, lng: 23.7275 },
                zoom: 12,
                mapTypeId: 'roadmap',
                styles: mapStyles
            });
            placesService = new google.maps.places.PlacesService(map);
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: '#c0392b', strokeWeight: 5 } });
            const CityLabelOverlay = class extends google.maps.OverlayView {
                constructor(position, text) {
                    super();
                    this.position = position;
                    this.text = text;
                }
                onAdd() {
                    const div = document.createElement('div');
                    div.style.cssText = 'position:absolute;color:#1a1a1a;font-size:13px;font-weight:600;font-family:Inter,sans-serif;white-space:nowrap;z-index:8;pointer-events:none;';
                    div.textContent = this.text;
                    this.div = div;
                    this.getPanes().overlayMouseTarget.appendChild(div);
                }
                draw() {
                    if (!this.div || !this.position) return;
                    const proj = this.getProjection();
                    if (!proj) return;
                    const point = proj.fromLatLngToDivPixel(this.position);
                    if (point) {
                        this.div.style.left = (point.x - this.div.offsetWidth / 2) + 'px';
                        this.div.style.top = (point.y - 8) + 'px';
                    }
                }
                onRemove() {
                    if (this.div && this.div.parentNode) this.div.parentNode.removeChild(this.div);
                    this.div = null;
                }
            };
            const greekCities = [
                { name: 'ŒëŒ∏ŒÆŒΩŒ±', lat: 37.9838, lng: 23.7275 },
                { name: 'ŒòŒµœÉœÉŒ±ŒªŒøŒΩŒØŒ∫Œ∑', lat: 40.6401, lng: 22.9444 },
                { name: 'Œ†Œ¨œÑœÅŒ±', lat: 38.2466, lng: 21.7346 },
                { name: 'ŒõŒ¨œÅŒπœÉŒ±', lat: 39.6390, lng: 22.4191 },
                { name: 'ŒíœåŒªŒøœÇ', lat: 39.3666, lng: 22.9442 },
                { name: 'ŒôœâŒ¨ŒΩŒΩŒπŒΩŒ±', lat: 39.6650, lng: 20.8537 },
                { name: 'Œ§œÅŒØŒ∫Œ±ŒªŒ±', lat: 39.5550, lng: 21.7672 },
                { name: 'ŒßŒ±ŒªŒ∫ŒØŒ¥Œ±', lat: 38.4636, lng: 23.6094 },
                { name: 'Œ£Œ≠œÅœÅŒµœÇ', lat: 41.0852, lng: 23.5487 },
                { name: 'ŒëŒªŒµŒæŒ±ŒΩŒ¥œÅŒøœçœÄŒøŒªŒ∑', lat: 40.8475, lng: 25.8744 },
                { name: 'ŒûŒ¨ŒΩŒ∏Œ∑', lat: 41.1344, lng: 24.8883 },
                { name: 'ŒöŒ±œÑŒµœÅŒØŒΩŒ∑', lat: 40.2699, lng: 22.5069 },
                { name: 'ŒëŒ≥œÅŒØŒΩŒπŒø', lat: 38.6214, lng: 21.4078 },
                { name: 'ŒöŒ±ŒªŒ±ŒºŒ¨œÑŒ±', lat: 37.0382, lng: 22.1142 },
                { name: 'ŒöŒ±Œ≤Œ¨ŒªŒ±', lat: 40.9397, lng: 24.4014 },
                { name: 'ŒõŒ±ŒºŒØŒ±', lat: 38.8993, lng: 22.4342 },
                { name: 'ŒöŒøŒºŒøœÑŒ∑ŒΩŒÆ', lat: 41.1224, lng: 25.4052 },
                { name: 'ŒîœÅŒ¨ŒºŒ±', lat: 41.1511, lng: 24.1397 },
                { name: 'ŒíŒ≠œÅŒøŒπŒ±', lat: 40.5236, lng: 22.2034 },
                { name: 'ŒöŒøŒ∂Œ¨ŒΩŒ∑', lat: 40.3006, lng: 21.7890 },
                { name: 'ŒöŒ±œÅŒ¥ŒØœÑœÉŒ±', lat: 39.3646, lng: 21.9218 },
                { name: 'ŒöœåœÅŒπŒΩŒ∏ŒøœÇ', lat: 37.9386, lng: 22.9321 },
                { name: 'Œ†œÑŒøŒªŒµŒºŒ±ŒêŒ¥Œ±', lat: 40.5147, lng: 21.6786 },
                { name: 'Œ§œÅŒØœÄŒøŒªŒ∑', lat: 37.5089, lng: 22.3797 },
                { name: 'Œ†œçœÅŒ≥ŒøœÇ', lat: 37.6751, lng: 21.4410 },
                { name: 'ŒìŒπŒ±ŒΩŒΩŒπœÑœÉŒ¨', lat: 40.7919, lng: 22.4075 },
                { name: 'ŒöŒπŒªŒ∫ŒØœÇ', lat: 40.9939, lng: 22.8753 },
                { name: 'ŒÜœÅŒ≥ŒøœÇ', lat: 37.6333, lng: 22.7333 },
                { name: 'ŒÜœÅœÑŒ±', lat: 39.1622, lng: 20.9853 },
                { name: 'ŒúŒ≠Œ≥Œ±œÅŒ±', lat: 37.9947, lng: 23.3422 },
                { name: 'ŒòŒÆŒ≤Œ±', lat: 38.3180, lng: 23.3190 },
                { name: 'ŒõŒπŒ≤Œ±Œ¥ŒµŒπŒ¨', lat: 38.4366, lng: 22.8736 },
                { name: 'Œ†œÅŒ≠Œ≤ŒµŒ∂Œ±', lat: 38.9556, lng: 20.7503 },
                { name: 'ŒöŒ±œÉœÑŒøœÅŒπŒ¨', lat: 40.5198, lng: 21.2682 },
                { name: 'Œ£œÄŒ¨œÅœÑŒ∑', lat: 37.0739, lng: 22.4300 },
                { name: 'Œ¶ŒªœéœÅŒπŒΩŒ±', lat: 40.7820, lng: 21.4097 },
                { name: 'ŒàŒ¥ŒµœÉœÉŒ±', lat: 40.8011, lng: 22.0483 },
                { name: 'ŒùŒ±œçœÄŒªŒπŒø', lat: 37.5677, lng: 22.8020 }
            ];
            greekCities.forEach(c => {
                const label = new CityLabelOverlay(new google.maps.LatLng(c.lat, c.lng), c.name);
                label.setMap(map);
            });
            log('initMap: OK - ŒßŒ¨œÅœÑŒ∑œÇ Œ≠œÑŒøŒπŒºŒøœÇ');
            loadPlacesFromUrl();
            window.addEventListener('resize', updateSortButtonVisibility);
        }

        function togglePlaceCard(placeIdent) {
            const card = document.querySelector(`[data-place-id="${placeIdent}"]`);
            if (card) card.classList.toggle('expanded');
        }

        function setMapType(type) {
            if (!map) return;
            map.setMapTypeId(type === 'satellite' ? 'hybrid' : 'roadmap');
            document.getElementById('mapTypeBtn').classList.toggle('active', type === 'roadmap');
            document.getElementById('satelliteBtn').classList.toggle('active', type === 'satellite');
        }

        // Parse Google Maps URL to extract coordinates or place info
        function parseGoogleMapsUrl(url) {
            if (!url || !url.trim()) return null;
            url = url.trim();
            log('parseGoogleMapsUrl: ' + url.substring(0, 80) + '...');

            // Extract place name from /place/Name/ (often before @)
            let placeName = null;
            const placeNameMatch = url.match(/\/place\/([^/@]+)/);
            if (placeNameMatch) {
                placeName = decodeURIComponent(placeNameMatch[1].replace(/\+/g, ' ').replace(/%2C/g, ','));
                log('parseGoogleMapsUrl: ŒíœÅŒ≠Œ∏Œ∑Œ∫Œµ œåŒΩŒøŒºŒ± ŒºŒ≠œÅŒøœÖœÇ: ' + placeName);
            }

            // Extract coordinates from @lat,lng pattern
            const coordMatch = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (coordMatch) {
                const lat = parseFloat(coordMatch[1]);
                const lng = parseFloat(coordMatch[2]);
                log('parseGoogleMapsUrl: ŒíœÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ œÉœÖŒΩœÑŒµœÑŒ±Œ≥ŒºŒ≠ŒΩŒµœÇ: ' + lat + ', ' + lng);
                return {
                    type: 'coords',
                    lat, lng,
                    placeName: placeName || undefined
                };
            }

            // Extract place_id (ChIJ... format)
            const placeIdMatch = url.match(/(ChIJ[a-zA-Z0-9_-]{20,})/);
            if (placeIdMatch) {
                log('parseGoogleMapsUrl: ŒíœÅŒ≠Œ∏Œ∑Œ∫Œµ place_id: ' + placeIdMatch[1]);
                return { type: 'placeId', placeId: placeIdMatch[1] };
            }

            // Only place name, no coords
            if (placeName) {
                log('parseGoogleMapsUrl: ŒßœÅŒÆœÉŒ∑ ŒºœåŒΩŒø œåŒΩŒøŒºŒ±: ' + placeName);
                return { type: 'text', query: placeName };
            }

            log('parseGoogleMapsUrl: ŒëœÄŒøœÑœÖœáŒØŒ± - Œ¥ŒµŒΩ Œ±ŒΩŒ±Œ≥ŒΩœâœÅŒØœÉœÑŒ∑Œ∫Œµ œÑŒø link');
            return null;
        }

        async function addPlace() {
            if (!map || !placesService) {
                log('addPlace: ŒßŒ¨œÅœÑŒ∑œÇ Œ¥ŒµŒΩ Œ≠œáŒµŒπ œÜŒøœÅœÑœâŒ∏ŒµŒØ Œ±Œ∫œåŒºŒ±! Œ†ŒµœÅŒØŒºŒµŒΩŒµ...', 'error');
                alert('Œ†ŒµœÅŒØŒºŒµŒΩŒµ ŒΩŒ± œÜŒøœÅœÑœéœÉŒµŒπ Œø œáŒ¨œÅœÑŒ∑œÇ...');
                return;
            }
            const input = document.getElementById('mapLinkInput');
            const url = input.value.trim();
            if (!url) return;

            log('addPlace: ŒûŒµŒ∫ŒπŒΩŒ¨ŒºŒµ Œ≥ŒπŒ± URL...');
            const parsed = parseGoogleMapsUrl(url);
            if (!parsed) {
                alert('ŒúŒ∑ Œ≠Œ≥Œ∫œÖœÅŒø link. ŒßœÅŒ∑œÉŒπŒºŒøœÄŒøŒØŒ∑œÉŒµ Œ≠ŒΩŒ± œÄŒªŒÆœÅŒµœÇ link Œ±œÄœå œÑŒø Google Maps (œÄ.œá. google.com/maps/place/...)');
                return;
            }

            input.value = '';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('placesTitle').style.display = 'block';

            const loadingCard = createLoadingCard();
            document.getElementById('placesList').appendChild(loadingCard);

            try {
                log('addPlace: parsed = ' + JSON.stringify(parsed));
                let placeData;
                if (parsed.type === 'placeId') {
                    log('addPlace: Œ†œÅŒøœÉœÄŒ¨Œ∏ŒµŒπŒ± getPlaceDetails ŒºŒµ placeId');
                    placeData = await getPlaceDetails(parsed.placeId);
                } else if (parsed.type === 'coords') {
                    log('addPlace: Œ†œÅŒøœÉœÄŒ¨Œ∏ŒµŒπŒ± findPlaceFromCoords ' + parsed.lat + ',' + parsed.lng + (parsed.placeName ? ' name=' + parsed.placeName : ''));
                    placeData = await findPlaceFromCoords(parsed.lat, parsed.lng, parsed.placeName);
                } else {
                    log('addPlace: Œ†œÅŒøœÉœÄŒ¨Œ∏ŒµŒπŒ± findPlaceFromText: ' + parsed.query);
                    placeData = await findPlaceFromText(parsed.query);
                }

                if (placeData) {
                    log('addPlace: ŒïœÄŒπœÑœÖœáŒØŒ±! ' + placeData.name, 'success');
                    addPlaceToMap(placeData);
                    places.push(placeData);
                    updateDistances();
                    updateShareButtonVisibility();
                    savePlacesToStorage();
                } else {
                    throw new Error('ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ œÑŒø ŒºŒ≠œÅŒøœÇ');
                }
            } catch (err) {
                log('addPlace: Œ£Œ¶ŒëŒõŒúŒë - ' + (err.message || err), 'error');
                alert('Œ£œÜŒ¨ŒªŒºŒ±: ' + (err.message || 'ŒîŒµŒΩ ŒÆœÑŒ±ŒΩ Œ¥œÖŒΩŒ±œÑŒÆ Œ∑ œÜœåœÅœÑœâœÉŒ∑ œÑŒøœÖ ŒºŒ≠œÅŒøœÖœÇ'));
            } finally {
                loadingCard.remove();
            }
        }

        function createLoadingCard() {
            const div = document.createElement('div');
            div.className = 'loading-place';
            div.style.minWidth = '120px';
            div.style.flexShrink = '0';
            div.innerHTML = '‚è≥ Œ¶œåœÅœÑœâœÉŒ∑...';
            return div;
        }

        function getPlaceDetails(placeId) {
            log('getPlaceDetails: placeId=' + placeId);
            return new Promise((resolve, reject) => {
                const request = {
                    placeId,
                    fields: ['name', 'geometry', 'formatted_address', 'photos', 'reviews', 'rating',
                             'user_ratings_total', 'opening_hours', 'place_id']
                };
                placesService.getDetails(request, (place, status) => {
                    log('getPlaceDetails: status=' + status + (place ? ' name=' + place.name : ''));
                    if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                        resolve(enrichPlaceData(place));
                    } else {
                        reject(new Error('getPlaceDetails failed: ' + status));
                    }
                });
            });
        }

        function findPlaceFromCoords(lat, lng, placeName) {
            const location = new google.maps.LatLng(lat, lng);

            const tryFindPlaceFromQuery = () => {
                if (!placeName || placeName.length < 2) return Promise.reject(new Error('No place name'));
                log('findPlaceFromCoords: findPlaceFromQuery ŒºŒµ "' + placeName + '"');
                return new Promise((resolve, reject) => {
                    const request = {
                        query: placeName,
                        fields: ['place_id', 'name', 'geometry'],
                        locationBias: { lat, lng }
                    };
                    placesService.findPlaceFromQuery(request, (results, status) => {
                        log('findPlaceFromQuery status: ' + status + ', results: ' + (results ? results.length : 0));
                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                            log('findPlaceFromQuery: ŒíœÅŒ≠Œ∏Œ∑Œ∫Œµ place_id ' + results[0].place_id);
                            getPlaceDetails(results[0].place_id).then(resolve).catch(reject);
                        } else {
                            reject(new Error('findPlaceFromQuery: ' + status));
                        }
                    });
                });
            };

            const tryGeocoder = () => {
                log('findPlaceFromCoords: Geocoder reverse geocode...');
                return new Promise((resolve, reject) => {
                    geocoder.geocode({ location }, (geoResults, geoStatus) => {
                        log('Geocoder status: ' + geoStatus + ', results: ' + (geoResults ? geoResults.length : 0));
                        if (geoStatus === 'OK' && geoResults && geoResults.length > 0) {
                            const p = geoResults[0];
                            if (p.place_id) {
                                log('Geocoder: place_id ' + p.place_id + ' - getPlaceDetails');
                                getPlaceDetails(p.place_id).then(resolve).catch(() => {
                                    const placeData = createMinimalPlace(lat, lng, p.formatted_address, p.place_id);
                                    resolve(placeData);
                                });
                            } else {
                                resolve(createMinimalPlace(lat, lng, p.formatted_address, null));
                            }
                        } else {
                            resolve(createMinimalPlace(lat, lng, null, null));
                        }
                    });
                });
            };

            const createMinimalPlace = (la, lo, addr, pid) => ({
                name: placeName || addr || `ŒòŒ≠œÉŒ∑ (${la.toFixed(4)}, ${lo.toFixed(4)})`,
                geometry: { location: new google.maps.LatLng(la, lo) },
                formatted_address: addr || '',
                place_id: pid,
                photos: [], reviews: [], rating: null, user_ratings_total: 0, opening_hours: null
            });

            return tryFindPlaceFromQuery().catch(() => tryGeocoder());
        }

        function findPlaceFromText(query) {
            log('findPlaceFromText: query=' + query);
            return new Promise((resolve, reject) => {
                const request = {
                    query,
                    fields: ['place_id']
                };
                placesService.findPlaceFromQuery(request, (results, status) => {
                    log('findPlaceFromText: status=' + status + ', results=' + (results ? results.length : 0));
                    if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                        getPlaceDetails(results[0].place_id).then(resolve).catch(reject);
                    } else {
                        reject(new Error('ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œµ ŒºŒ≠œÅŒøœÇ Œ≥ŒπŒ±: ' + query + ' (status: ' + status + ')'));
                    }
                });
            });
        }

        function enrichPlaceData(place) {
            return {
                ...place,
                geometry: place.geometry,
                name: place.name || 'ŒÜŒ≥ŒΩœâœÉœÑŒø',
                formatted_address: place.formatted_address || '',
                photos: place.photos || [],
                reviews: (place.reviews || []).slice(0, 3),
                rating: place.rating,
                user_ratings_total: place.user_ratings_total || 0,
                opening_hours: place.opening_hours || null
            };
        }

        function addPlaceToMap(place) {
            if (!PlaceInfoOverlay) return;
            const marker = new google.maps.Marker({
                position: place.geometry.location,
                map,
                title: place.name
            });

            const infoWindow = new google.maps.InfoWindow({
                content: buildInfoContent(place)
            });

            const overlay = new PlaceInfoOverlay(place.geometry.location, place, map);
            overlay.setMap(map);

            const openInfo = () => {
                if (window.lastInfoWindow) window.lastInfoWindow.close();
                infoWindow.open(map, marker);
                window.lastInfoWindow = infoWindow;
                document.querySelectorAll('.place-card').forEach(c => c.classList.remove('active'));
                const card = document.querySelector(`[data-place-id="${place.place_id || 'loc_' + place.geometry.location.lat() + '_' + place.geometry.location.lng()}"]`);
                if (card) card.classList.add('active');
            };

            marker.addListener('click', openInfo);

            markers.push({ marker, place, overlay });
            map.panTo(place.geometry.location);

            if (places.length === 1) {
                map.setZoom(15);
                clearRoute();
            } else if (places.length > 1) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(({ marker }) => bounds.extend(marker.getPosition()));
                map.fitBounds(bounds, 50);
                updateRoute();
            }

            addPlaceCard(place);
        }

        function clearRoute() {
            directionsRenderer.setMap(null);
            clearRouteLabels();
        }

        function clearRouteLabels() {
            routeLabelOverlays.forEach(o => o.setMap(null));
            routeLabelOverlays = [];
        }

        function updateRoute() {
            if (places.length < 2) {
                clearRoute();
                clearRouteLabels();
                return;
            }
            const origin = places[0].geometry.location;
            const destination = places[places.length - 1].geometry.location;
            const waypoints = places.slice(1, -1).map(p => ({ location: p.geometry.location, stopover: true }));
            directionsService.route({
                origin,
                destination,
                waypoints,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    directionsRenderer.setMap(map);
                    clearRouteLabels();
                    const legs = result.routes[0].legs;
                    legs.forEach(leg => {
                        let path = [];
                        leg.steps.forEach(step => {
                            if (step.path) path = path.concat(step.path);
                        });
                        if (path.length > 0) {
                            const midIdx = Math.floor(path.length / 2);
                            const midPos = path[midIdx];
                            const labelText = leg.distance.text + ' ‚Ä¢ ' + leg.duration.text;
                            const labelOverlay = new RouteLabelOverlay(midPos, labelText, map);
                            labelOverlay.setMap(map);
                            routeLabelOverlays.push(labelOverlay);
                        }
                    });
                } else {
                    clearRoute();
                    clearRouteLabels();
                }
            });
        }

        function buildMapsUrl(place, pos) {
            const lat = pos ? pos.lat() : (place.geometry && place.geometry.location ? place.geometry.location.lat() : null);
            const lng = pos ? pos.lng() : (place.geometry && place.geometry.location ? place.geometry.location.lng() : null);
            const coord = (lat != null && lng != null) ? `${lat},${lng}` : null;
            const q = encodeURIComponent(place.name || coord || '');
            if (place.place_id && q) {
                return `https://www.google.com/maps/search/?api=1&query=${q}&query_place_id=${encodeURIComponent(place.place_id)}`;
            }
            return `https://www.google.com/maps/search/?api=1&query=${q}`;
        }
        function buildInfoContent(place) {
            const mapsUrl = buildMapsUrl(place, place.geometry && place.geometry.location ? place.geometry.location : null);
            let html = `<div style="max-width: 340px; font-family: 'Inter', sans-serif; color: #2c3e50;">`;
            html += `<h3 style="margin: 0 0 8px; font-size: 16px;">${place.name}</h3>`;
            if (place.formatted_address) html += `<p style="font-size: 12px; color: #64748b; margin: 0 0 8px;">${place.formatted_address}</p>`;
            if (place.rating) html += `<p style="margin: 0 0 8px; font-weight: 600;">‚≠ê ${place.rating} <span style="color:#64748b;font-weight:400">(${place.user_ratings_total} Œ±ŒæŒπŒøŒªŒøŒ≥ŒÆœÉŒµŒπœÇ)</span></p>`;
            if (place.photos && place.photos.length > 0) {
                const urls = place.photos.slice(0, 4).map(p => p.getUrl({ maxWidth: 150, maxHeight: 150 }));
                html += `<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;">` + urls.map(u => `<a href="${mapsUrl}" target="_blank"><img src="${u}" style="width:70px;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;" alt="ŒÜŒΩŒøŒπŒ≥ŒºŒ± œÉŒµ Google Maps"></a>`).join('') + `</div>`;
            }
            if (place.reviews && place.reviews.length > 0) {
                html += `<div style="font-size: 11px; color: #475569; margin-bottom: 8px; max-height: 80px; overflow-y: auto;">`;
                place.reviews.forEach(r => { html += `<p style="margin: 4px 0;">${r.rating}‚≠ê ${(r.text || '').substring(0, 80)}...</p>`; });
                html += `</div>`;
            }
            if (place.opening_hours) {
                html += `<div style="font-size: 12px; border-top: 1px solid #e2e8f0; padding-top: 8px;">`;
                html += place.opening_hours.open_now ? 'üü¢ <strong>ŒëŒΩŒøŒπœáœÑœå œÑœéœÅŒ±</strong>' : 'üî¥ <strong>ŒöŒªŒµŒπœÉœÑœå</strong>';
                if (place.opening_hours.weekday_text) {
                    html += '<div style="margin-top: 6px; font-size: 11px;">' + place.opening_hours.weekday_text.map(r => r.replace(':', ': ')).join('<br>') + '</div>';
                }
                html += `</div>`;
            }
            html += '</div>';
            return html;
        }

        function addPlaceCard(place) {
            const card = document.createElement('div');
            card.className = 'place-card';
            const placeIdent = place.place_id || ('loc_' + place.geometry.location.lat() + '_' + place.geometry.location.lng());
            card.dataset.placeId = placeIdent;
            card.draggable = true;

            let photosHtml = '';
            if (place.photos && place.photos.length > 0) {
                const photoUrls = place.photos.slice(0, 4).map(p => 
                    p.getUrl({ maxWidth: 160, maxHeight: 160 })
                );
                photosHtml = `<div class="place-photos">${photoUrls.map(url => `<img src="${url}" alt="">`).join('')}</div>`;
            }

            let reviewsHtml = '';
            if (place.reviews && place.reviews.length > 0) {
                reviewsHtml = `<div class="place-reviews">${place.reviews.map(r => 
                    `<div class="review"><strong>${r.rating}‚≠ê</strong> ${(r.text || '').substring(0, 100)}...</div>`
                ).join('')}</div>`;
            }

            let hoursHtml = '';
            if (place.opening_hours) {
                const openText = place.opening_hours.open_now ? '<span class="open-now">üü¢ ŒëŒΩŒøŒπœáœÑœå œÑœéœÅŒ±</span>' : '<span class="closed-now">üî¥ ŒöŒªŒµŒπœÉœÑœå</span>';
                let weekdays = '';
                if (place.opening_hours.weekday_text) {
                    weekdays = place.opening_hours.weekday_text.map(row => 
                        `<div class="hours-row">${row.replace(':', ': ')}</div>`
                    ).join('');
                }
                hoursHtml = `<div class="place-opening-hours">${openText}${weekdays ? '<div style="margin-top: 6px;">' + weekdays + '</div>' : ''}</div>`;
            }

            card.innerHTML = `
                <div class="place-card-header">
                    <span class="drag-handle" title="Œ£œçœÅŒµ Œ≥ŒπŒ± ŒΩŒ± Œ±ŒªŒªŒ¨ŒæŒµŒπœÇ œÉŒµŒπœÅŒ¨">‚ãÆ‚ãÆ</span>
                    <button class="expand-btn" title="ŒïŒºœÜŒ¨ŒΩŒπœÉŒ∑ ŒªŒµœÄœÑŒøŒºŒµœÅŒµŒπœéŒΩ" onclick="event.stopPropagation(); togglePlaceCard('${placeIdent}')">ü¶å</button>
                    <h3 style="flex:1">${place.name}</h3>
                    <button class="place-remove" onclick="removePlace('${placeIdent}')" title="ŒëœÜŒ±ŒØœÅŒµœÉŒ∑">√ó</button>
                </div>
                <div class="place-card-details">
                    ${place.formatted_address ? `<div class="address">${place.formatted_address}</div>` : ''}
                    ${place.rating ? `<div class="place-rating"><span class="stars">${'‚òÖ'.repeat(Math.round(place.rating))}${'‚òÜ'.repeat(5-Math.round(place.rating))}</span> ${place.rating} (${place.user_ratings_total})</div>` : ''}
                    ${photosHtml}
                    ${reviewsHtml}
                    ${hoursHtml}
                </div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('place-remove') && !e.target.classList.contains('drag-handle') && !e.target.classList.contains('expand-btn')) {
                    map.panTo(place.geometry.location);
                    map.setZoom(16);
                    const iw = markers.find(m => (m.place.place_id || 'loc_' + m.place.geometry.location.lat() + '_' + m.place.geometry.location.lng()) === placeIdent);
                    if (iw) google.maps.event.trigger(iw.marker, 'click');
                }
            });

            card.addEventListener('dragstart', (e) => {
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', placeIdent);
                e.dataTransfer.effectAllowed = 'move';
            });
            card.addEventListener('dragend', () => card.classList.remove('dragging'));
            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer.types.includes('text/plain')) {
                    e.dataTransfer.dropEffect = 'move';
                    card.classList.add('drag-over');
                }
            });
            card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
            card.addEventListener('drop', (e) => {
                e.preventDefault();
                card.classList.remove('drag-over');
                const fromId = e.dataTransfer.getData('text/plain');
                if (fromId && fromId !== placeIdent) reorderPlaces(fromId, placeIdent);
            });

            document.getElementById('placesList').appendChild(card);
        }

        function reorderPlaces(fromPlaceId, toPlaceId) {
            const fromIdx = places.findIndex(p => (p.place_id || 'loc_' + p.geometry.location.lat() + '_' + p.geometry.location.lng()) === fromPlaceId);
            const toIdx = places.findIndex(p => (p.place_id || 'loc_' + p.geometry.location.lat() + '_' + p.geometry.location.lng()) === toPlaceId);
            if (fromIdx < 0 || toIdx < 0 || fromIdx === toIdx) return;
            const [movedPlace] = places.splice(fromIdx, 1);
            const [movedMarker] = markers.splice(fromIdx, 1);
            places.splice(toIdx, 0, movedPlace);
            markers.splice(toIdx, 0, movedMarker);
            const placesList = document.getElementById('placesList');
            const cards = [...placesList.querySelectorAll('.place-card')];
            const draggedCard = cards.find(c => c.dataset.placeId === fromPlaceId);
            const targetCard = cards.find(c => c.dataset.placeId === toPlaceId);
            if (draggedCard && targetCard) {
                if (fromIdx < toIdx) targetCard.after(draggedCard);
                else targetCard.before(draggedCard);
            }
            updateDistances();
            savePlacesToStorage();
        }

        function removePlace(placeIdent) {
            const idx = markers.findIndex(m => (m.place.place_id || 'loc_' + m.place.geometry.location.lat() + '_' + m.place.geometry.location.lng()) === placeIdent);
            if (idx >= 0) {
                markers[idx].marker.setMap(null);
                if (markers[idx].overlay) markers[idx].overlay.setMap(null);
                markers.splice(idx, 1);
                places.splice(idx, 1);
            }
            document.querySelector(`[data-place-id="${placeIdent}"]`)?.remove();
            if (places.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('placesTitle').style.display = 'none';
                document.getElementById('distancesSection').style.display = 'none';
                clearRoute();
            } else {
                updateDistances();
            }
            updateShareButtonVisibility();
            savePlacesToStorage();
        }

        function updateDistances() {
            const section = document.getElementById('distancesSection');
            const list = document.getElementById('distancesList');
            list.innerHTML = '';

            if (places.length < 2) {
                section.style.display = 'none';
                clearRoute();
                return;
            }
            section.style.display = 'block';
            updateRoute();

            const origins = places.map(p => p.geometry.location);
            const dests = places.map(p => p.geometry.location);

            const distanceMatrixService = new google.maps.DistanceMatrixService();
            distanceMatrixService.getDistanceMatrix({
                origins,
                destinations: dests,
                travelMode: google.maps.TravelMode.DRIVING
            }, (response, status) => {
                if (status !== 'OK') return;

                for (let i = 0; i < places.length - 1; i++) {
                    const j = i + 1;
                    const el = response.rows[i].elements[j];
                    if (el.status === 'OK') {
                        const row = document.createElement('div');
                        row.className = 'distance-row';
                        row.innerHTML = `
                            <span>${i + 1}. ${places[i].name} ‚Üí ${places[j].name}</span>
                            <span class="distance-info">${el.distance.text} ‚Ä¢ ${el.duration.text}</span>
                        `;
                        list.appendChild(row);
                    }
                }
            });
        }

        function clearAll() {
            markers.forEach(({ marker, overlay }) => {
                marker.setMap(null);
                if (overlay) overlay.setMap(null);
            });
            markers = [];
            places = [];
            clearRoute();
            const placesList = document.getElementById('placesList');
            placesList.innerHTML = '<div class="empty-state" id="emptyState"><p><strong>Œ†œÅœåœÉŒ∏ŒµœÉŒµ œÄŒøŒªŒªŒ¨ links Œ±œÄœå Google Maps</strong></p><p>ŒòŒ± Œ¥ŒµŒπœÇ œÑŒ±œÖœÑœåœáœÅŒøŒΩŒ± Œ≥ŒπŒ± œåŒªŒ±: œÜœâœÑŒøŒ≥œÅŒ±œÜŒØŒµœÇ, Œ±ŒæŒπŒøŒªŒøŒ≥ŒÆœÉŒµŒπœÇ, œâœÅŒ¨œÅŒπŒø Œ∫Œ±Œπ Œ±œÄŒøœÉœÑŒ¨œÉŒµŒπœÇ!</p></div>';
            document.getElementById('placesTitle').style.display = 'none';
            document.getElementById('distancesSection').style.display = 'none';
            updateShareButtonVisibility();
            savePlacesToStorage();
        }

        function updateShareButtonVisibility() {
            const btn = document.getElementById('shareBtn');
            if (btn) btn.style.display = places.length > 0 ? 'inline-flex' : 'none';
            updateSortButtonVisibility();
        }

        function updateSortButtonVisibility() {
            const iconBtn = document.getElementById('sortBtn');
            if (iconBtn) iconBtn.style.display = (places.length >= 2 && window.innerWidth <= 900) ? 'flex' : 'none';
            const placesBtn = document.getElementById('sortPlacesBtn');
            if (placesBtn) placesBtn.style.display = places.length >= 2 ? 'inline-block' : 'none';
        }

        function openSortModal() {
            buildSortModalList();
            document.getElementById('sortModal').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closeSortModal() {
            document.getElementById('sortModal').classList.remove('visible');
            document.body.style.overflow = '';
        }

        function buildSortModalList() {
            const list = document.getElementById('sortModalList');
            list.innerHTML = '';
            places.forEach((p, i) => {
                const ident = p.place_id || ('loc_' + p.geometry.location.lat() + '_' + p.geometry.location.lng());
                const div = document.createElement('div');
                div.className = 'sort-modal-item';
                div.draggable = true;
                div.dataset.placeId = ident;
                div.innerHTML = `<span class="drag-handle">‚ãÆ‚ãÆ</span><span>${i + 1}. ${p.name}</span><button class="sort-modal-remove" onclick="event.stopPropagation(); removePlace('${ident}'); closeSortModal();" title="ŒëœÜŒ±ŒØœÅŒµœÉŒ∑">√ó</button>`;
                div.addEventListener('dragstart', (e) => {
                    div.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', ident);
                    e.dataTransfer.effectAllowed = 'move';
                });
                div.addEventListener('dragend', () => div.classList.remove('dragging'));
                div.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer.types.includes('text/plain')) {
                        e.dataTransfer.dropEffect = 'move';
                        div.classList.add('drag-over');
                    }
                });
                div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
                div.addEventListener('drop', (e) => {
                    e.preventDefault();
                    div.classList.remove('drag-over');
                    const fromId = e.dataTransfer.getData('text/plain');
                    if (fromId && fromId !== ident) {
                        reorderPlaces(fromId, ident);
                        buildSortModalList();
                    }
                });
                list.appendChild(div);
            });
        }

        const STORAGE_KEY = 'mapsExplorer_places';

        function buildShareData() {
            return places.map(p => {
                if (p.place_id && p.place_id.startsWith('ChIJ')) return p.place_id;
                const loc = p.geometry.location;
                const lat = typeof loc.lat === 'function' ? loc.lat() : loc.lat;
                const lng = typeof loc.lng === 'function' ? loc.lng() : loc.lng;
                return `${lat.toFixed(5)}~${lng.toFixed(5)}`;
            }).join('|');
        }

        function savePlacesToStorage() {
            if (places.length === 0) localStorage.removeItem(STORAGE_KEY);
            else localStorage.setItem(STORAGE_KEY, buildShareData());
        }

        function copyShareLink() {
            if (places.length === 0) return;
            const data = buildShareData();
            const base = window.location.origin + window.location.pathname;
            const url = base + (window.location.search ? '&' : '?') + 'p=' + encodeURIComponent(data);
            navigator.clipboard.writeText(url).then(() => alert('Link Œ±ŒΩœÑŒπŒ≥œÅŒ¨œÜŒ∑Œ∫Œµ! ŒöŒøŒπŒΩœåœÑœÖœÄŒ≠ œÑŒø Œ≥ŒπŒ± ŒΩŒ± ŒºŒøŒπœÅŒ±œÉœÑŒµŒØœÇ œÑŒ± ŒºŒ≠œÅŒ∑ œÉŒøœÖ.')).catch(() => prompt('ŒëŒΩœÑŒπŒ≥œÅŒ¨œàŒµ œÑŒø link:', url));
        }

        async function loadPlacesFromTokens(tokens) {
            if (!tokens || tokens.length === 0) return;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('placesTitle').style.display = 'block';
            for (const token of tokens) {
                try {
                    let placeData;
                    if (token.startsWith('ChIJ')) {
                        placeData = await getPlaceDetails(token);
                    } else {
                        const [latStr, lngStr] = token.split('~');
                        const lat = parseFloat(latStr), lng = parseFloat(lngStr);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            placeData = await findPlaceFromCoords(lat, lng, null);
                        }
                    }
                    if (placeData) {
                        addPlaceToMap(placeData);
                        places.push(placeData);
                    }
                } catch (e) {}
            }
            updateDistances();
            updateShareButtonVisibility();
            savePlacesToStorage();
        }

        async function loadPlacesFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const p = params.get('p');
            if (p && p.trim()) {
                const tokens = decodeURIComponent(p).split('|').filter(Boolean);
                await loadPlacesFromTokens(tokens);
                return;
            }
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored && stored.trim()) {
                const tokens = stored.split('|').filter(Boolean);
                await loadPlacesFromTokens(tokens);
            }
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDc__yRSw8pvfjlthJ6YlQ9AH8qbbZXXCg&libraries=places&callback=initMap">
    </script>
</body>
</html>
